{% extends "base.html" %}
{% block content %}
<div class="container mt-4" style="max-width:400px;">
  <h2 class="mb-4">Join a Game</h2>
  <form method="post" class="mx-auto" style="max-width: 400px;">
    <div class="mb-3">
      <label for="game_id" class="form-label">Select Game</label>
      <select name="game_id" id="game_id" class="form-select" required>
        {% for game in games %}
          <option value="{{ game.id }}">{{ game.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="team_id" class="form-label">Join Existing Team</label>
      
        {% if games and games|length > 0 %}
            <select name="team_id" id="team_id" class="form-select">
            {% for team in teams_by_game[games[0].id] %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
            </select>
        {% else %}
            <div class="alert alert-warning">No games available.</div>
        {% endif %}
      
    </div>
    <div class="mb-3">
      <label for="new_team_name" class="form-label">Or Create New Team</label>
      <input type="text" name="new_team_name" id="new_team_name" class="form-control" placeholder="Enter new team name">
    </div>
    <button type="submit" class="btn btn-primary w-100">Join/Create</button>
  </form>
</div>
  <script>
    // Teams by game as a JS object
    /*
    const teamsByGame = {{ teams_by_game | tojson }};
    const teamSelect = document.getElementById('team_id');
    const gameSelect = document.getElementById('game_id');

    gameSelect.addEventListener('change', function() {
      const gameId = this.value;
      const teams = teamsByGame[gameId] || [];
      teamSelect.innerHTML = '';
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = team.name;
        teamSelect.appendChild(option);
      });
    });

    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
    const teamSelected = teamSelect && teamSelect.value;
    const newTeamName = document.getElementById('new_team_name').value.trim();
    if (!teamSelected && !newTeamName) {
        e.preventDefault();
        alert('Please select a team or enter a new team name.');
    }
    });
    */
  </script>

  <script type="module">
import { sendOrQueue } from "/static/js/offline-sync.js";

const form = document.querySelector('form');
const teamSelect = document.getElementById('team_id');
const newTeamInput = document.getElementById('new_team_name');
const gameSelect = document.getElementById('game_id');

// Teams by game for dynamic select updates
const teamsByGame = {{ teams_by_game | tojson }};
gameSelect.addEventListener('change', function() {
  const gameId = this.value;
  const teams = teamsByGame[gameId] || [];
  teamSelect.innerHTML = '';
  teams.forEach(team => {
    const option = document.createElement('option');
    option.value = team.id;
    option.textContent = team.name;
    teamSelect.appendChild(option);
  });
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const gameId = gameSelect.value;
  const teamId = teamSelect.value || null;
  const newTeamName = newTeamInput.value.trim() || null;

  if (!teamId && !newTeamName) {
    alert('Please select a team or enter a new team name.');
    return;
  }

  const payload = {
    game_id: gameId,
    team_id: teamId,
    new_team_name: newTeamName
  };

  await sendOrQueue({
    url: '/api/joingame',
    method: 'POST',
    body: payload,
    timestamp: Date.now()
  }, {
    onSuccess: (data) => {
      if (data.success) {
        alert(data.message);
        window.location.href = '/'; // redirect to main page or game page
      } else {
        alert(data.message || "Failed to join game.");
      }
    },
    onQueued: () => {
      alert('Offline: join/create action saved locally and will sync later.');
    },
    onFailure: (err) => {
      console.error('Join game failed:', err);
      alert('Failed to submit join/create request.');
    }
  });
});
</script>

{% endblock %}