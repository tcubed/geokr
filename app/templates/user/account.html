{% extends "base.html" %}
{% block title %}My Account â€“ GeoKR{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width:600px;">

  <h1 class="mb-4">My Account</h1>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="accountTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">Profile</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="joingame-tab" data-bs-toggle="tab" data-bs-target="#joingame" type="button" role="tab">Join Game</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="switchgame-tab" data-bs-toggle="tab" data-bs-target="#switchgame" type="button" role="tab">Switch Game</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options" type="button" role="tab">Options</button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content p-3 border border-top-0">

    <!-- Profile tab -->
    <div class="tab-pane fade show active" id="profile" role="tabpanel">
      <form method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="display_name" class="form-label">Display Name</label>
          <input type="text" class="form-control" id="display_name" name="display_name" value="{{ user.display_name or '' }}">
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" name="email" value="{{ user.email or '' }}">
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
      </form>
    </div>

    <!-- Join Game tab -->
    <div class="tab-pane fade" id="joingame" role="tabpanel">
      <h5>Join or Create a Team</h5>
      <form id="joinGameForm">
        <div class="mb-3">
          <label for="game_id" class="form-label">Select Game</label>
          <select name="game_id" id="game_id" class="form-select" required>
            {% for game in games %}
              <option value="{{ game.id }}">{{ game.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="team_id" class="form-label">Join Existing Team</label>
          <select name="team_id" id="team_id" class="form-select">
            {% if games %}
              {% for team in teams_by_game[games[0].id] %}
                <option value="{{ team.id }}">{{ team.name }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <div class="mb-3">
          <label for="new_team_name" class="form-label">Or Create New Team</label>
          <input type="text" name="new_team_name" id="new_team_name" class="form-control" placeholder="Enter new team name">
        </div>
        <button type="submit" class="btn btn-primary w-100">Join/Create</button>
      </form>
    </div>

    <!-- Switch Game tab -->
    <!-- Switch Game tab -->
    <div class="tab-pane fade" id="switchgame" role="tabpanel">
      <h5>Switch Active Team</h5>
      <select id="active_team_select" class="form-select">
        {% for membership in current_user.team_memberships %}
          <option value="{{ membership.team.id }}"
            {% if session.active_team_id == membership.team.id %}selected{% endif %}>
            [{{ membership.team.game.name }}] {{ membership.team.name }} 
          </option>
        {% endfor %}
      </select>
    </div>


    <!-- Options tab -->
    <div class="tab-pane fade" id="options" role="tabpanel">
      <h5>Preferences</h5>
      <form id="options-form">
        <div class="form-check">
            <label for="location_mode">Location usage</label>
            <select name="location_mode" id="location_mode" disabled>
            <option value="none"  {{ 'selected' if location_mode == 'none' }}>No location</option>
            <option value="watch" {{ 'selected' if location_mode == 'watch' }}>Track position (live)</option>
            <option value="current" {{ 'selected' if location_mode == 'current' }}>Get position on demand</option>
            </select>
        </div>

        <h6 class="mt-3">Troubleshooting</h6>
        
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="default_pos_mode" name="default_pos_mode" disabled
            {% if request.cookies.get('default_pos_mode') == '1' %}checked{% endif %}>
          <label class="form-check-label" for="default_pos_mode">Default Position mode</label>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="debug_mode" name="debug_mode" disabled
            {% if debug_mode %}checked{% endif %}>
          <label class="form-check-label" for="debug_mode">Debug mode</label>
        </div>

        {% if "mapper" in options %}
        <h6 class="mt-3">Game Building</h6>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="mapper_mode" name="mapper_mode"
            {% if request.cookies.get('mapper_mode') == '1' %}checked{% endif %}>
          <label class="form-check-label" for="mapper_mode">Mapper mode</label>
        </div>
        {% endif %}

        <button type="submit" class="btn btn-primary mt-3">Save</button>
      </form>
    </div>
  </div>
</div>

<div id="sync-toast-container" style="position: fixed; bottom: 20px; right: 20px; max-width: 300px; display: flex; flex-direction: column; gap: 8px; z-index:10001;"></div>

{#
<script type="module">
  //import { sendOrQueue } from "/static/js/offline-sync.js";
  import { gameState, saveState } from './localStorage.js';
  const { sendOrQueue } = window.offlineSync; // or self.offlineSync

  // Join game dynamic team list:
  const teamsByGame = {{ teams_by_game | tojson }};
  const teamSelect = document.getElementById('team_id');
  const gameSelect = document.getElementById('game_id');

  const storedGameId = gameState.gameId || (gameSelect.options[0] && gameSelect.options[0].value);
  const storedTeamId = gameState.teamId;

  function populateTeams(gameId, selectedTeamId) {
    const teams = teamsByGame[gameId] || [];
    teamSelect.innerHTML = '';
    teams.forEach(team => {
      const option = document.createElement('option');
      option.value = team.id;
      option.textContent = team.name;
      if (selectedTeamId && team.id == selectedTeamId) option.selected = true;
      teamSelect.appendChild(option);
    });

    // fallback: select first if none selected
    if (!teamSelect.value && teams.length) {
      teamSelect.value = teams[0].id;
    }
  }

  // --- Populate game dropdown ---
  gameSelect.value = storedGameId;
  populateTeams(storedGameId, storedTeamId);

  // --- Update teams when game changes ---
  gameSelect.addEventListener('change', () => {
    const gameId = gameSelect.value;
    populateTeams(gameId, null);
  });

  // Join game submit:
  const joinForm = document.getElementById('joinGameForm');
  if (joinForm) {
    joinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newTeamInput = document.getElementById('new_team_name');
      const gameId = gameSelect.value;
      const teamId = teamSelect.value || null;
      const newTeamName = newTeamInput.value.trim() || null;
      if (!teamId && !newTeamName) {
        alert('Please select a team or enter a new team name.');
        return;
      }

      // Update gameState immediately
      if (teamId) {
        gameState.gameId = gameId;
        gameState.teamId = parseInt(teamId, 10);
        saveState();
      }

      await sendOrQueue({
        url: '/api/joingame',
        method: 'POST',
        body: { game_id: gameId, team_id: teamId, new_team_name: newTeamName },
        timestamp: Date.now()
      }, {
        onSuccess: (data) => {
          if (data.success) {
            alert(data.message);
            window.location.href = '/';
          } else alert(data.message || "Failed to join game.");
        },
        onQueued: () => alert('Offline: join/create action saved locally and will sync later.'),
        onFailure: (err) => console.error('Join game failed:', err)
      });
    });
  }

  // Options save:
  const optionsForm = document.getElementById('options-form');
  if (optionsForm) {
    optionsForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const debug = document.getElementById('debug_mode').checked ? '1' : '';
      const locationMode = document.getElementById('location_mode').value; // 'none', 'watch', 'current'
 
      const default_pos = document.getElementById('default_pos_mode').checked ? '1' : '';
      document.cookie = "debug_mode=" + debug + ";path=/;max-age=31536000";
      document.cookie = "location_mode=" + locationMode + ";path=/;max-age=31536000";
      document.cookie = "default_pos_mode=" + default_pos + ";path=/;max-age=31536000";
      const mapperBox = document.getElementById('mapper_mode');
      if (mapperBox) {
        const mapper = mapperBox.checked ? '1' : '';
        document.cookie = "mapper_mode=" + mapper + ";path=/;max-age=31536000";
      }
      window.location = "/findloc";
    });
  }

</script>
#}

<script>
  // Start time when HTML starts parsing
  window._pageStart = performance.now();

  window.addEventListener('load', () => {
    const loadTime = performance.now() - window._pageStart;
    console.log(`[Timing] Page fully loaded in ${loadTime.toFixed(1)} ms`);
  });

  document.addEventListener('DOMContentLoaded', () => {
    const domTime = performance.now() - window._pageStart;
    console.log(`[Timing] DOMContentLoaded in ${domTime.toFixed(1)} ms`);
  });
</script>
{% endblock %}
