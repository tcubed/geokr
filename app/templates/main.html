{% extends "base.html" %}

{% block title %}
Geokr{% if game and game.name %} - {{ game.name }}{% endif %}
{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
    /*
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
    */
  #main-flex {
    display: flex;
    flex-direction: column;
    height: calc(100dvh - 65px);
    /*min-height: 90vh;
    height: 90vh;*/
    padding-bottom: env(safe-area-inset-bottom);
  }
  #top-content {
    flex: 0 0 auto;
    padding: 5px;
    background: #fff;
    z-index: 2;
    margin-top:0;
    margin-bottom: 0; /* Ensure no margin below */
  }
  #map {
    flex: 1 1 auto;
    min-height: 0;
    z-index: 1;
    /* Remove fixed height, let flexbox control it */
  }
  #bottom-buttons {
    flex: 0 0 auto;
    padding: 10px;
    padding-bottom: calc(env(safe-area-inset-bottom, 24px) + 24px); /* extra space for comfort */
    background: #fff;
    border-top: 1px solid #eee;
    text-align: center;
    z-index: 2;
  }
</style>
{% endblock %}

{% block content %}
  

<div id="main-flex">
  <div id="top-content">
    <!--
    <ul id="clue-list"></ul>
    -->
    <div id="progress"></div>
  </div>
  <!--
  <div id="map" style="height: 300px; width: 100%; margin-top: 20px;"></div>
  -->
  <div id="map"></div>

  <div id="bottom-buttons" class="d-flex gap-2">
    {% for action in actions %}
      {% if action == "check_clues" %}
        <button onclick="getClues()" class="btn btn-primary w-100 flex-fill">Check for Clues</button>
      {% elif action == "mapper" %}
        <button onclick="sendToNewPin()" class="btn btn-success w-100 flex-fill">New Pin</button>
      {% else %}
        <button class="btn btn-light w-100 flex-fill">{{ action|capitalize }}</button>
      {% endif %}
    {% endfor %}
  </div>
</div>

  
<div id="prefetch-container">
  <button id="prefetch-btn" style="display:none;">Pre-fetch Maps</button>
  <span id="offline-text" style="display:none; font-weight: bold; color: red;">Offline</span>
</div>

<!-- External JS -->
<!-- LEAFLET GLOBAL VARIABLE IS "L"-->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
    // Pass bounds from Flask to JS
    const min_lat = {{ game.min_lat or 'null' }};
    const max_lat = {{ game.max_lat or 'null' }};
    const min_lng = {{ game.min_lon or 'null' }};
    const max_lng = {{ game.max_lon or 'null' }};
    const zooms = "14,15,16";  // Or pass from Flask if dynamic
  </script>
<script>
  const defaultPosMode = getCookie('default_pos_mode') === '1';
  console.log('Default position mode:', defaultPosMode);
if (!defaultPosMode && navigator.geolocation) {
  console.log('get current position');
  navigator.geolocation.getCurrentPosition(pos => {
    showMap(pos.coords.latitude, pos.coords.longitude);
  });
}
else {
  console.log('show map with default position');
  var lat=(min_lat + max_lat) / 2;
  var lon=(min_lng + max_lng) / 2;
  showMap(lat,lon);
}
</script>

<script>
  const btn = document.getElementById('prefetch-btn');
  const offlineText = document.getElementById('offline-text');

  function updateOnlineStatus() {
    if (navigator.onLine) {
      btn.style.display = 'inline-block';
      offlineText.style.display = 'none';
    } else {
      btn.style.display = 'none';
      offlineText.style.display = 'inline';
    }
  }

  updateOnlineStatus();
  setInterval(updateOnlineStatus, 2000);

  btn.addEventListener('click', () => {
    // Replace this with your actual prefetch function
    alert('Starting map prefetch...');
    prefetchTiles();
  });
</script>


<!-- THIS SHOULD BE GOING AWAY/CHANGED TO SYNC LATER WHEN ONLINE-->
<script>
  async function updateProgress() {
    //const teamId = localStorage.getItem('team_id');
    //if (!teamId) return;
    const teamId = {{ team.id }};
    const res = await fetch(`/api/team/progress/${teamId}`);
    const data = await res.json();
    document.getElementById('progress').textContent = `Clues found: ${data.clues_found.length}`;
  }
</script>

{% endblock %}
