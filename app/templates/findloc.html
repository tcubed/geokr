{% extends "base.html" %}

{% block title %}
Geokr{% if game and game.name %} - {{ game.name }}{% endif %}
{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
 
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!--
<link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
-->
<style>
  .found-image {
    filter: grayscale(100%);
    opacity: 0.6;
  }

  .found-label {
    color: white;
    background-color: rgba(0,0,0,0.6);
    padding: 0.25rem 0.5rem;
    font-weight: bold;
    font-size: 1.25rem;
    border-radius: 0.3rem;
    pointer-events: none;
    user-select: none;
    white-space: nowrap;
  }
</style>

{% endblock %}
{% block content %}
<div id="game-data"
  data-game-id="{{ game.id }}"
  data-team-id="{{ team.id }}"
  data-next-index="{{ next_index }}"
  data-locations='{{ locations|tojson|safe }}'
  data-bounds="{{ [game.min_lat, game.min_lon, game.max_lat, game.max_lon]|tojson }}"
  data-location-images="{{ locations|map(attribute='image_url')|select('string')|list|tojson }}">
</div>

<div id="prefetch-container">
  <button id="prefetch-btn" style="display:none;">Download Game Assets</button>
  <span id="offline-text" style="display:none; font-weight: bold; color: red;">Offline</span>
</div>

<div class="accordion" id="locationAccordion">
  {% for loc in locations %}
  <div class="accordion-item locked-clue clue-card" 
       id="clue-{{ loc.id }}" 
       data-clue-index="{{ loop.index0 }}"
       {% if loop.index0 > current_index %}style="display: none;"{% endif %}>
    
    <h2 class="accordion-header">
      <button class="accordion-button {% if loop.index0 != current_index %}collapsed{% endif %}" 
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#collapse-{{ loc.id }}">
        {{ loc.name }}
      </button>
    </h2>

    <div id="collapse-{{ loc.id }}" 
         class="accordion-collapse collapse {% if loop.index0 == current_index %}show{% endif %}"
         data-bs-parent="#locationAccordion">
      <div class="accordion-body">
       
        {{ loc.description }}

        {% if loc.image_url %}
        <div class="location-card position-relative mb-3">
          <img src="{{ loc.image_url }}" alt="{{ loc.name }}" class="card-img-top" style="max-width: 300px;">
        </div>
        {% endif %}

        <p class="card-text">{{ loc.clue_text | safe }}</p>

        {% if loc.latitude and loc.longitude %}
        <div id="map-{{ loc.id }}" class="map-container"
             data-lat="{{ loc.lat }}" data-lon="{{ loc.lon }}" style="height: 200px;"></div>
        {% endif %}

        <!-- VALIDATION BUTTONS -->
        <div id="validation-methods">
          <button class="btn btn-primary btn-validate-direct" 
                  data-location-id="{{ loc.id }}"
                  data-clue-index="{{ loop.index0 }}">
            Mark Directly
          </button>

          {% if enable_geolocation %}
          <button id="btn-validate-geo" class="btn btn-primary mt-2">Use Location</button>
          {% endif %}

          {% if enable_image_verify %}
          <button id="btn-validate-image" class="btn btn-primary mt-2">Match Image</button>
          <div>
            <h1>Find the Clue</h1>
            <div id="container">
              <video id="camera" autoplay playsinline></video>
              <img class="overlay" src="/static/target.png" />
            </div>
            <br>
            <button id="capture-btn">Verify</button>
            <div id="status-img"></div>
          </div>
          {% endif %}

          {% if enable_qr_scanner %}
          <button id="btn-validate-qr" class="btn btn-primary mt-2">Scan QR Code</button>
          <div id="qr-container">
            <video id="qr-video" style="width: 100%; max-width: 400px;"></video>
            <canvas id="qr-canvas" style="display: none;"></canvas>
            <p id="qr-result">Awaiting scan...</p>
          </div>
          {% endif %}

          {% if enable_selfie %}
          <button id="btn-validate-selfie" class="btn btn-primary mt-2">Take Selfie</button>
          {% endif %}
        </div>
        
      </div>
    </div>
  </div>
  {% endfor %}

  {% if completion_duration %}
  <div class="card mt-4 border-success">
    <div class="card-header bg-success text-white">
      üéâ Team Completed!
    </div>
    <div class="card-body">
      <h5 class="card-title">Completion Time</h5>
      <p class="card-text">{{ completion_duration }}</p>
    </div>
  </div>
  {% endif %}
</div>



<div id="sync-status" style="position: fixed; top: 10px; right: 10px; z-index: 10000; font-family: system-ui; display: flex; gap: 8px; align-items: center;">
  <div id="pending-badge" style="background:#f59e0b; color:#fff; padding:4px 8px; border-radius:12px; font-size:12px; display:none;">
    ‚è≥ <span id="pending-count">0</span> pending
  </div>
</div>
<!-- Toast container -->
<div id="sync-toast-container" style="position: fixed; bottom: 20px; right: 20px; max-width: 300px; display: flex; flex-direction: column; gap: 8px; z-index:10001;"></div>



<!--

<div id="clue"></div>
<div id="progress">Found 0 of X</div>
<div id="next-location">Next: TBD</div>
-->
<div id="status"></div>

<div id="clue-container"></div>

<div id="fireworks-container"></div>

<button id="btn-reset-locations" class="btn btn-warning">Reset All Locations</button>


{% endblock %}

{% block scripts %}

<script type="module">
//import { clearOfflineQueue } from '/static/js/offline-sync.js';
import { clearOfflineQueueForTeam } from '/static/js/app-init.js';

document.getElementById('btn-reset-locations').addEventListener('click', async () => {
  if (!confirm('Really reset all location progress for this team?')) return;

  try {
    // Reset local game state first (offline-safe)
    if (window.gameState) {
      gameState.locations.forEach(loc => loc.found = false);
      gameState.currentIndex = 0;

      // Save state if you have a saveState function
      if (typeof saveState === 'function') saveState();
    }

    // Clear queued offline updates for this team
    await clearOfflineQueueForTeam(GAME_DATA.teamId);

    // Try server reset if online
    if (navigator.onLine) {
      const resp = await fetch('/debug/reset-locations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ team_id: GAME_DATA.teamId })
      });
      const data = await resp.json();
      console.log('Server reset:', data);
      alert(data.message || 'Reset done');
    } else {
      alert('Offline: local reset done. Server will sync when back online.');
    }

    // Reload the page (SW cache will serve the full page)
    location.reload();

  } catch (err) {
    console.error(err);
    alert('Reset failed');
  }
});
</script>


<script src="/static/js/utils.js"></script>
<script>
  const watchPosition = getCookie('watch_position') === '1';
  const defaultPosMode = getCookie('default_pos_mode') === '1';
  window.watchPosition = watchPosition;
  window.defaultPosMode = defaultPosMode;
  window.DEBUG_GAME_STATE = true; // or false to disable

  // Static metadata for the game ‚Äî never mutated
  window.GAME_DATA = {
    gameId: {{ game.id }},
    teamId: {{ team.id }},
    locations: {{ locations|tojson|safe }},
    nextIndex: {{ current_index }}
  };

  // Precompute location images for prefetch
  window.locationImageUrls = GAME_DATA.locations.map(l => l.image_url).filter(Boolean);

  // Map bounds
  window.bounds = [
    {{ game.min_lat }},
    {{ game.min_lon }},
    {{ game.max_lat }},
    {{ game.max_lon }}
  ];
</script>


<!-- JS Libraries -->
<!-- indexedDB helper-->
<!--<script src="https://cdn.jsdelivr.net/npm/idb@7.1.1/build/iife/index-min.js"></script>
<script src="https://unpkg.com/idb@7.1.1/build/iife/index-min.js"></script>-->
<!--
<script type="module" src="{{ url_for('static', filename='libs/index.js') }}"></script>
-->
<!--
<script type="module" src="https://unpkg.com/idb@8.0.3/build/index.js"></script>
-->
<!-- Leaflet JS (must be before your custom script!) -->

<!--
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
-->
<!--
<script src="{{ url_for('static', filename='libs/leaflet.js') }}"></script>
-->
<!-- QR -->
 <!--
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
-->
<!--
<script src="{{ url_for('static', filename='libs/jsQR.js') }}"></script>
-->
<!-- Custom JS Modules -->
<!--

<script src="{{ url_for('static', filename='js/offline-db.js') }}"></script>
<script src="{{ url_for('static', filename='js/offline-sync.js') }}"></script>
-->
<script type="module" src="{{ url_for('static', filename='js/localStorage.js') }}"></script>

<script type="module" src="{{ url_for('static', filename='js/validate.js') }}"></script>


<script type="module" src="{{ url_for('static', filename='js/map.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/clue-manager.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/offline-game.js') }}"></script>


<script type="module" src="{{ url_for('static', filename='js/prefetch.js') }}"></script>

<script type="module" src="{{ url_for('static', filename='js/findloc.js') }}"></script>



<script type="module" src="{{ url_for('static', filename='js/app-init.js') }}"></script>
<script type="module">
    import { initQRScannerIfPresent } from "{{ url_for('static', filename='js/qr.js') }}";
    initQRScannerIfPresent();
</script>

<script>
  // PREFETCH LOGIC
  const btn = document.getElementById('prefetch-btn');
  const offlineText = document.getElementById('offline-text');

  function updateOnlineStatus() {
    if (navigator.onLine) {
      btn.style.display = 'inline-block';
      offlineText.style.display = 'none';
    } else {
      btn.style.display = 'none';
      offlineText.style.display = 'inline';
    }
  }

  updateOnlineStatus();
  setInterval(updateOnlineStatus, 2000);

  btn.addEventListener('click', async() => {
    // Replace this with your actual prefetch function
    alert('Starting prefetch...');
    // Prefetch tiles for multiple zoom levels
    await prefetchTiles(bounds,[14,15,16]);
    // Prefetch location images
    await prefetchAssets(locationImageUrls);
    // Prefetch API data for offline use
    await prefetchAPIs(['/api/game-data/{{ game.id }}']);
    console.log('All game assets downloaded for offline use!')
  });
</script>

<script>
  /*
window.addEventListener('online', async () => {
    console.log('[App] Back online, starting full sync...');
    try {
      // FULL SYNC: send queued updates and reconcile server state
      await offlineSync.syncWithServer({
        gameId: GAME_DATA.gameId,
        teamId: GAME_DATA.teamId,
        offlineDB: offlineDB
      });

      // REFRESH UI if needed
      if (typeof applyGameUpdate === 'function') {
        applyGameUpdate(window.gameState); // ensures UI matches latest state
      }

      console.log('[App] Offline updates synced and server state reconciled.');
    } catch (err) {
      console.error('[App] Full sync failed:', err);
    }
  });
  */




  /*
window.addEventListener('online', async () => {
  console.log('Back online, syncing updates...');
  const updates = await offlineDB.getAllUpdates();

  for (const update of updates) {
    try {
      const response = await fetch(update.url, {
        method: update.method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(update.body)
      });

      if (response.ok) {
        const data = await response.json();
        applyGameUpdate(data); // UI refresh
        await offlineDB.deleteUpdate(update.id);
      } else {
        console.error('Failed to sync update:', update);
      }
    } catch (err) {
      console.error('Sync error, will retry later:', update);
    }
  }
});
*/
</script>

{% endblock %}
