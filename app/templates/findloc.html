{% extends "base.html" %}

{% block title %}
Geokr{% if game and game.name %} - {{ game.name }}{% endif %}
{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
 
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!--
<link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
-->
<style>
  .found-image {
    filter: grayscale(100%);
    opacity: 0.6;
  }

  .found-label {
    color: white;
    background-color: rgba(0,0,0,0.6);
    padding: 0.25rem 0.5rem;
    font-weight: bold;
    font-size: 1.25rem;
    border-radius: 0.3rem;
    pointer-events: none;
    user-select: none;
    white-space: nowrap;
  }
  .clue-card {
    display: none;
}
</style>

{% endblock %}
{% block content %}
<div id="game-data"
  data-game-id="{{ game.id }}"
  data-team-id="{{ team.id }}"
  data-next-index="{{ next_index }}"
  data-locations='{{ locations|tojson|safe }}'
  data-bounds="{{ [game.min_lat, game.min_lon, game.max_lat, game.max_lon]|tojson }}"
  data-location-images="{{ locations|map(attribute='image_url')|select('string')|list|tojson }}">
</div>

<!--
<div id="prefetch-container">
  <button id="prefetch-btn" style="display:none;">Download Game Assets</button>
</div>
-->

<div class="accordion" id="locationAccordion">
  {% for loc in locations %}
  <div class="accordion-item locked-clue clue-card" 
       id="clue-{{ loc.id }}" 
       data-clue-index="{{ loop.index0 }}"
       {% if not loc.found and loop.index0 > current_index %}style="display: none;"{% endif %}>
    
    <h2 class="accordion-header">
      <button class="accordion-button {% if not loc.found or loop.index0 != current_index %}collapsed{% endif %}" 
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#collapse-{{ loc.id }}"
              {% if not loc.found or loop.index0 > current_index %}
                    aria-expanded="false"
                    {% else %}
                    aria-expanded="true"
                    {% endif %}
              >
        {{ loc.name }}
      </button>
    </h2>

    <div id="collapse-{{ loc.id }}" 
         class="accordion-collapse collapse {% if loop.index0 == current_index %}show{% endif %}"
         data-bs-parent="#locationAccordion">
      <div class="accordion-body">
       
        {{ loc.description }}

        {% if loc.image_url %}
        <div class="location-card position-relative mb-3">
          <img src="{{ loc.image_url }}" alt="{{ loc.name }}" class="card-img-top" style="max-width: 300px;">
        </div>
        {% endif %}

        <p class="card-text">{{ loc.clue_text | safe }}</p>

        {% if loc.latitude and loc.longitude %}
        <div id="map-{{ loc.id }}" class="map-container"
             data-lat="{{ loc.lat }}" data-lon="{{ loc.lon }}" style="height: 200px;"></div>
        {% endif %}

        <!-- VALIDATION BUTTONS -->
        <div id="validation-methods">
          <button class="btn btn-primary btn-validate-direct" 
                  data-location-id="{{ loc.id }}"
                  data-clue-index="{{ loop.index0 }}">
            Mark Directly
          </button>

          {% if enable_geolocation %}
          <button id="btn-validate-geo" class="btn btn-primary mt-2">Use Location</button>
          {% endif %}

          {% if enable_image_verify %}
          <button id="btn-validate-image" class="btn btn-primary mt-2">Match Image</button>
          <div>
            <h1>Find the Clue</h1>
            <div id="container">
              <video id="camera" autoplay playsinline></video>
              <img class="overlay" src="/static/target.png" />
            </div>
            <br>
            <button id="capture-btn">Verify</button>
            <div id="status-img"></div>
          </div>
          {% endif %}

          {% if enable_qr_scanner %}
          <button id="btn-validate-qr" class="btn btn-primary mt-2">Scan QR Code</button>
          <div id="qr-container">
            <video id="qr-video" style="width: 100%; max-width: 400px;"></video>
            <canvas id="qr-canvas" style="display: none;"></canvas>
            <p id="qr-result">Awaiting scan...</p>
          </div>
          {% endif %}

          {% if enable_selfie %}
          <button id="btn-validate-selfie" class="btn btn-primary mt-2">Take Selfie</button>
          {% endif %}
        </div>
        
      </div>
    </div>
  </div>
  {% endfor %}

  {% if completion_duration %}
  <div class="card mt-4 border-success">
    <div class="card-header bg-success text-white">
      üéâ Team Completed!
    </div>
    <div class="card-body">
      <h5 class="card-title">Completion Time</h5>
      <p class="card-text">{{ completion_duration }}</p>
    </div>
  </div>
  {% endif %}
</div>



<div id="sync-status" style="position: fixed; top: 10px; right: 10px; z-index: 10000; font-family: system-ui; display: flex; gap: 8px; align-items: center;">
  <div id="pending-badge" style="background:#f59e0b; color:#fff; padding:4px 8px; border-radius:12px; font-size:12px; display:none;">
    ‚è≥ <span id="pending-count">0</span> pending
  </div>
</div>
<!-- Toast container -->
<div id="sync-toast-container" style="position: fixed; bottom: 20px; right: 20px; max-width: 300px; display: flex; flex-direction: column; gap: 8px; z-index:10001;"></div>


<div id="status"></div>

<div id="clue-container"></div>

<div id="fireworks-container"></div>

{% endblock %}

{% block scripts %}
 {{ super() }}
<script type="module">
  const VERSION = "{{ version }}";
  console.log('VERSION: ', VERSION)
</script>

<script type="module">
  import { getCookie } from '/static/js/utils.js?v={{ version }}';
  const locationMode = getCookie('location_mode') || 'none';
  const defaultPosMode = getCookie('default_pos_mode') === '1';
  window.defaultPosMode = defaultPosMode;
  window.DEBUG_GAME_STATE = true;

  window.GAME_DATA = {
    gameId: {% if game is defined %}{{ game.id }}{% else %}null{% endif %},
    teamId: {% if team is defined %}{{ team.id }}{% else %}null{% endif %},
    locations: {{ locations|tojson|default('[]')|safe }},
    currentIndex: {{ current_index|default(0) }}
  };

  window.locationImageUrls = GAME_DATA.locations.map(l => l.image_url).filter(Boolean);

  window.bounds = [
    {% if game is defined %}
      {{ game.min_lat|default(0) }},
      {{ game.min_lon|default(0) }},
      {{ game.max_lat|default(0) }},
      {{ game.max_lon|default(0) }}
    {% else %}
      0,0,0,0
    {% endif %}
  ];

//console.log('Initial:', window.GAME_DATA.locations);
//setTimeout(()=>console.log('After 3s:', window.GAME_DATA.locations),3000);

</script>


<!-- JS Libraries -->
<!-- indexedDB helper-->

<script type="module" src="{{ url_for('static', filename='js/validate.js') }}?v={{ version }}"></script>
<script type="module" src="{{ url_for('static', filename='js/map.js') }}?v={{ version }}"></script>
<script type="module" src="{{ url_for('static', filename='js/findloc.js') }}?v={{ version }}"></script>
<script src="{{ url_for('static', filename='js/offline-sync-page.js') }}?v={{ version }}"></script>

<script type="module" src="{{ url_for('static', filename='js/offline-game.js') }}?v={{ version }}"></script>
<script type="module" src="{{ url_for('static', filename='js/app-init.js') }}?v={{ version }}"></script>
<script type="module">
    import { initQRScannerIfPresent } from "{{ url_for('static', filename='js/qr.js') }}";
    initQRScannerIfPresent();
</script>

<script>
  // PREFETCH LOGIC
  const btn = document.getElementById('prefetch-btn');
  if(btn){
    function updateOnlineItems() {
      if (navigator.onLine) {
        btn.style.display = 'inline-block';
      } else {
        btn.style.display = 'none';
      }
    }

    updateOnlineItems();
    setInterval(updateOnlineItems, 2000);

    btn.addEventListener('click', async() => {
      // Replace this with your actual prefetch function
      alert('Starting prefetch...');
      // Prefetch tiles for multiple zoom levels
      await prefetchTiles(bounds,[14,15,16]);
      // Prefetch location images
      await prefetchAssets(locationImageUrls);
      // Prefetch API data for offline use
      await prefetchAPIs(['/api/game-data/{{ game.id }}']);
      console.log('All game assets downloaded for offline use!')
    });
  }
</script>



{% endblock %}
